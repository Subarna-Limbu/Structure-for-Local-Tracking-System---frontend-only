{% extends 'base.html' %}
{% block content %}
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #mainContent {
            height: calc(100vh - 120px);
            min-height: 400px;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
    </style>
    <section>
    <h2 class="text-xl font-semibold mb-4">Live Bus Tracking & Seat Availability</h2>
    <div id="mainContent">
        <div id="map"></div>
    </div>
    <div class="mt-6">
        <h3 class="text-lg font-semibold mb-2">Seat Arrangement ({{ bus.total_seats }} seats)</h3>
        <div id="seatGrid" class="grid gap-2" style="grid-template-columns: repeat(5, 40px); max-width: 220px;">
            {% for seat, col in seat_grid_columns %}
                {% if forloop.counter0|divisibleby:4 and forloop.counter0 < last_row_start %}
                    <div style="grid-column: 1 / span 5; height: 5px;"></div>
                {% endif %}
                <button class="seat-btn {% if seat.is_available %}bg-green-400{% else %}bg-red-500{% endif %} text-white rounded w-10 h-10 focus:outline-none cursor-default" 
                    data-seat-id="{{ seat.id }}" 
                    style="grid-column: {{ col }};"
                    disabled
                    title="Seat {{ seat.seat_number }} - {% if seat.is_available %}Available{% else %}Occupied{% endif %}"
                    >{{ seat.seat_number }}</button>
            {% endfor %}
        </div>
        <div class="text-sm text-gray-600 mt-2">Green = available, Red = occupied. (Read-only for passengers)</div>
    </div>
    <div class="mt-6">
        {% if user.is_authenticated %}
            <button id="bookmarkBtn" class="bg-blue-500 text-white p-2 rounded">
                {% if is_bookmarked %}Remove Bookmark{% else %}Bookmark this bus{% endif %}
            </button>
            <div class="mt-4">
                <h4 class="font-semibold">Request Pickup</h4>
                <textarea id="pickupStop" class="p-2 border rounded w-96" rows="2">{{ default_pickup }}</textarea>
                <div class="mt-2">
                    <input id="pickupMsg" placeholder="Optional message" class="p-2 border rounded w-64" />
                    <button id="sendPickup" class="bg-green-500 text-white p-2 rounded ml-2">Send</button>
                </div>
            </div>

            <!-- Toast container -->
            <div id="toastContainer" style="position:fixed; top:20px; right:20px; z-index:9999;"></div>

            <div id="chatContainer" class="mt-6 border p-2" style="max-width:600px;">
                <h4 class="font-semibold">Chat with Driver</h4>
                <div id="chatLog" style="height:200px; overflow:auto; border:1px solid #ddd; padding:8px; background:#fafafa;"></div>
                <div class="mt-2">
                    <input id="chatInput" placeholder="Type message" class="p-2 border rounded w-3/4" />
                    <button id="sendChat" class="bg-blue-600 text-white p-2 rounded">Send</button>
                </div>
            </div>
        {% else %}
            <div class="text-sm text-gray-600">Log in to bookmark, request pickup, or chat with driver.</div>
        {% endif %}
    </div>
</section>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const busId = "{{ bus_id }}";
        const socket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/location/' + busId + '/');
        let map = L.map('map').setView([27.7172, 85.3240], 13); // Default to Kathmandu
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        let marker = null;
        let locationReceived = false;
        socket.onmessage = function(event){
            const data = JSON.parse(event.data);
            if (data.lat && data.lng) {
                locationReceived = true;
                if (!marker) {
                    marker = L.marker([data.lat, data.lng]).addTo(map);
                } else {
                    marker.setLatLng([data.lat, data.lng]);
                }
                map.setView([data.lat, data.lng], 15);
                document.getElementById('locationStatus').innerText = "Bus location updated.";
            }
        };
        setTimeout(function(){
            if (!locationReceived) {
                document.getElementById('locationStatus').innerText = "";
                if (!marker) {
                    marker = L.marker([27.7172, 85.3240]).addTo(map);
                }
            }
        }, 10000);
    </script>
    <script>
    // Bookmark logic
    {% if user.is_authenticated %}
    const bookmarkBtn = document.getElementById('bookmarkBtn');
    bookmarkBtn && bookmarkBtn.addEventListener('click', function(){
        const url = '{{ is_bookmarked|yesno:"/api/remove_bookmark/,/api/bookmark_bus/" }}';
        fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
            body: 'bus_id=' + encodeURIComponent(busId)
        }).then(r => r.json()).then(data => {
            if (data.status === 'success') {
                if (bookmarkBtn.innerText.includes('Remove')) {
                    bookmarkBtn.innerText = 'Bookmark this bus';
                } else {
                    bookmarkBtn.innerText = 'Remove Bookmark';
                }
            }
        });
    });

    // Pickup request via AJAX with validation and toasts
    function showToast(message, type){
        const el = document.createElement('div');
        el.innerText = message;
        el.style.padding = '10px 14px';
        el.style.borderRadius = '6px';
        el.style.marginTop = '8px';
        el.style.color = '#fff';
        el.style.minWidth = '180px';
        el.style.boxShadow = '0 2px 6px rgba(0,0,0,0.15)';
        if (type === 'success') el.style.background = '#16a34a'; else if (type === 'error') el.style.background = '#dc2626'; else el.style.background = '#374151';
        const container = document.getElementById('toastContainer');
        container.appendChild(el);
        setTimeout(()=>{ el.style.opacity = '0'; setTimeout(()=>el.remove(),400); }, 3000);
    }

    document.getElementById('sendPickup').addEventListener('click', function(){
        const stop = document.getElementById('pickupStop').value.trim();
        const message = document.getElementById('pickupMsg').value.trim();
        if (!stop) { showToast('Please enter a pickup location.', 'error'); return; }
        const btn = this;
        btn.disabled = true;
        fetch('/api/send_pickup/', {
            method: 'POST',
            headers: {'Content-Type':'application/x-www-form-urlencoded', 'X-CSRFToken': '{{ csrf_token }}'},
            body: 'bus_id=' + encodeURIComponent(busId) + '&stop=' + encodeURIComponent(stop) + '&message=' + encodeURIComponent(message)
        }).then(r => r.json()).then(data => {
            if (data.status === 'success') {
                showToast('Pickup request sent.', 'success');
            } else {
                showToast('Error: ' + (data.error || 'failed'), 'error');
            }
        }).catch(err=>{ showToast('Network error', 'error'); }).finally(()=>{ btn.disabled = false; });
    });

    // Chat websocket
    const chatLog = document.getElementById('chatLog');
    const chatInput = document.getElementById('chatInput');
    const sendChat = document.getElementById('sendChat');
    const chatRoom = "{{ chat_room }}";
    let chatSocket = null;
    if (chatRoom) {
        chatSocket = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/chat/' + chatRoom + '/');
        chatSocket.onopen = function(){ console.log('User chat socket opened:', chatRoom); };
        chatSocket.onmessage = function(e){
            console.log('User WS raw message:', e.data);
            let d = null;
            try { d = JSON.parse(e.data); } catch(err){ console.error('User WS parse error', err); return; }
            if (d.type === 'chat_message') {
                const el = document.createElement('div');
                const isMe = (d.sender_id === {{ request.user.id }});
                let senderLabel = 'Driver';
                if (isMe) {
                    senderLabel = 'You';
                } else if (d.sender_name) {
                    senderLabel = d.sender_name + ' (driver)';
                }
                el.innerText = (senderLabel + ': ') + d.content;
                chatLog.appendChild(el);
                chatLog.appendChild(el);
                console.log('Appended to user chatLog:', el.innerText);
                chatLog.scrollTop = chatLog.scrollHeight;
            } else if (d.type === 'pickup_notification') {
                // Ignore - pickup notifications go to driver
            }
        }
    }

    // debug area for last incoming raw frame
    const lastIncomingUser = document.createElement('div');
    lastIncomingUser.id = 'lastIncomingUserRaw';
    lastIncomingUser.style.fontSize = '12px';
    lastIncomingUser.style.color = '#555';
    lastIncomingUser.style.marginTop = '6px';
    chatLog.parentNode.insertBefore(lastIncomingUser, chatLog.nextSibling);

    sendChat && sendChat.addEventListener('click', function(){
        const content = chatInput.value.trim();
        if (!content || !chatSocket) return;
        const payload = {type: 'chat_message', content: content, recipient_id: {% if bus and bus.driver and bus.driver.user %}{{ bus.driver.user.id }}{% else %}null{% endif %}, bus_id: busId};
        chatSocket.send(JSON.stringify(payload));
        chatInput.value = '';
    });
    {% endif %}
    </script>
    <div id="locationStatus" class="mt-2 text-red-500 font-semibold"></div>
{% endblock %}
